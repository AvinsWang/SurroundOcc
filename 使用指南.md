# 配置环境


下载这个docker:  
```docker pull ruoqian/bevformer:ngc2012_latest```

激活conda环境  
```conda activate open-mmlab```

安装mmcv:  
```pip install mmcv-full==1.4.0 -f https://download.openmmlab.com/mmcv/dist/cu111/torch1.9.0/index.html```

安装mmdet3d  
```
git clone https://github.com/open-mmlab/mmdetection3d.git
cd mmdetection3d
git checkout v0.17.1 # Other versions may not be compatible.
python setup.py install
```

安装open3d
```
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple open3d==0.12.0
```


安装chamfer
```
cd SurroundOcc/extensions/chamfer_dist
python setup.py install --user
```

下载预训练权重
```
cd SurroundOcc 
mkdir ckpts

cd ckpts & wget https://github.com/zhiqi-li/storage/releases/download/v1.0/r101_dcn_fcos3d_pretrain.pth
```

下载pkl文件
```
[train](https://cloud.tsinghua.edu.cn/f/ebbed36c37b248149192/?dl=1)/[val](https://cloud.tsinghua.edu.cn/f/b3f169f4db034764bb87/?dl=1)
```

训练
```
./tools/dist_train.sh ./projects/configs/surroundocc/surroundocc.py 8  ./work_dirs/surroundocc
```
or  
```
export CUDA_VISIBLE_DEVICES=1,2,3,4,5,6,7;./tools/dist_train.sh ./projects/configs/surroundocc/surroundocc.py 7  ./work_dirs/surroundocc
```

推理   
```
./tools/dist_inference.sh ./projects/configs/surroundocc/surroundocc_inference.py ./path/to/ckpts.pth 8
```

# 生成Occ稠密语义标签
原生代码启动  
```
python generate_occupancy_nuscenes.py --config_path ./config.yaml --label_mapping ./nuscenes.yaml --split val --save_path ./data

```
**重构的代码(推荐)**  
需要修改的地方:  
tools/gen_occ_nus/config.py  
- save_dir: 存储路径  
- seg_label: 'lidar_seg'    # 这里需要修改
``` shell
cd project_root/
bash tools/gen_occ_nus/parallel.sh
```
注意: 需要修改parallel.sh中的MAX_PARALLEL数量,以达到最大生成速度.  
当前配置是在我机器上达到20~30mins/scene, 所以理论上约8h能够生成完,    
> CPU: AMD EPYC 7763, 256 cores  
RAM: 750GB / 1024GB  
GPU: 8x3090  